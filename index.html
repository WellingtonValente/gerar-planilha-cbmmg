<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerar Planilha Excel (.xlsx)</title>
  <!-- CDN principal -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <!-- Fallback: se o CDN acima falhar -->
  <script>
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('XLSX')) {
        var alt = document.createElement('script');
        alt.src = 'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js';
        document.head.appendChild(alt);
      }
    });
  </script>
  <style>
    body {font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 30px; max-width: 900px; margin-left:auto; margin-right:auto;}
    h1 {color: #93c5fd;}
    textarea {width: 100%; height: 260px; margin-top: 10px; border-radius: 10px; border: 1px solid #1e293b; background: #1e293b; color: #e5e7eb; padding: 10px; font-family: monospace;}
    input {background: #1e293b; border: 1px solid #1e293b; color: #e5e7eb; padding: 8px; border-radius: 6px;}
    button {margin-top: 15px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;}
    .primary {background: #2563eb; color: white;}
    .secondary {background: #334155; color: white;}
    .status {margin-top: 10px; font-weight: bold;}
    .ok {color: #22c55e;}
    .err {color: #ef4444;}
    .tip {margin-top: 15px; color: #94a3b8; font-size: 0.9rem;}
  </style>
</head>
<body>
  <h1>Gerar Planilha Excel (.xlsx)</h1>
  <p>Cole abaixo o conteúdo <b>CSV</b> ou <b>JSON</b> que o GPT forneceu.</p>
  <textarea id="data" placeholder="empresa,cidade,ocupacao
Loja Exemplo,BH,Comercial
Mercado Central,BH,Serviços"></textarea><br>
  <label>Nome da aba: <input id="sheet" value="Planilha" /></label>
  <label> Nome do arquivo: <input id="filename" value="planilha_cbmmg.xlsx" /></label><br>
  <button class="primary" onclick="gerar()">Gerar .xlsx</button>
  <button class="secondary" onclick="amostraCSV()">Exemplo CSV</button>
  <button class="secondary" onclick="amostraJSON()">Exemplo JSON</button>
  <p id="status" class="status"></p>
  <div class="tip">
    Dica: Se usar CSV, a primeira linha deve ser o cabeçalho. Evite vírgulas dentro das células. Nenhum dado é enviado a servidores.
  </div>
  <script>
    function msg(t, ok=true){const el=document.getElementById('status');el.className='status '+(ok?'ok':'err');el.textContent=t;}
    function amostraCSV(){
      document.getElementById('data').value='empresa,cidade,ocupacao\nLoja Exemplo,BH,Comercial\nMercado Central,BH,Serviços';
      msg('Exemplo CSV carregado');
    }
    function amostraJSON(){
      document.getElementById('data').value='[{"empresa":"Loja Exemplo","cidade":"BH","ocupacao":"Comercial"},{"empresa":"Mercado Central","cidade":"BH","ocupacao":"Serviços"}]';
      msg('Exemplo JSON carregado');
    }
    function gerar(){
      const txt=document.getElementById('data').value.trim();
      if(!txt){msg('Cole dados CSV ou JSON primeiro.',false);return;}
      let dados;
      try{
        dados=JSON.parse(txt);
      }catch(e){
        const linhas=txt.split(/\r?\n/).filter(x=>x.trim());
        const cab=linhas[0].split(',');
        dados=linhas.slice(1).map(l=>{
          const col=l.split(',');
          let obj={};
          cab.forEach((c,i)=>obj[c]=col[i]||'');
          return obj;
        });
      }
      try{
        const wb=XLSX.utils.book_new();
        const ws=XLSX.utils.json_to_sheet(dados);
        XLSX.utils.book_append_sheet(wb,ws,document.getElementById('sheet').value||'Planilha');
        XLSX.writeFile(wb,document.getElementById('filename').value||'planilha.xlsx');
        msg('✅ Planilha gerada com sucesso!');
      }catch(e){
        msg('Erro: '+e.message,false);
      }
    }
  </script>
</body>
</html>
